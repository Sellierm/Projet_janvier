<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../css/index.css">
        <link type="text/css" rel="stylesheet" href="../css/header.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <style>
            .eachHour{
                height: 10px;
                border: 1px solid black;
                width: 80px;
            }
        </style>
    </head>
    <body style="margin: 0;">
        <canvas oncontextmenu="return false;" id="myCanvas" style="margin: auto;"></canvas><!--width="900" height="500"-->
        <div id="bulleInfo" style="position: fixed; top: 10px; right: 10px; width: 15%; height: fit-content; background-color: antiquewhite; display: flex; flex-direction: column; align-items: center; visibility: hidden;">
            <div>
                <p>Salle </p>
                <p id="name"></p>
            </div>
            <div>
                <p >Vidéo projecteur</p>
                <p id="proj"></p>
            </div>
            <div>
                <table>
                    <thead>
                        <td id="day"></td>
                    </thead>
                    <tbody style="display: flex; flex-direction: column;">
                        <tr data-time="7:00" class="eachHour"></tr>
                        <tr data-time="7:30" class="eachHour"></tr>
                        <tr data-time="8:00" class="eachHour"></tr>
                        <tr data-time="8:30" class="eachHour"></tr>
                        <tr data-time="9:00" class="eachHour"></tr>
                        <tr data-time="9:30" class="eachHour"></tr>
                        <tr data-time="10:00" class="eachHour"></tr>
                        <tr data-time="10:30" class="eachHour"></tr>
                        <tr data-time="11:00" class="eachHour"></tr>
                        <tr data-time="11:30" class="eachHour"></tr>
                        <tr data-time="12:00" class="eachHour"></tr>
                        <tr data-time="12:30" class="eachHour"></tr>
                        <tr data-time="13:00" class="eachHour"></tr>
                        <tr data-time="13:30" class="eachHour"></tr>
                        <tr data-time="14:00" class="eachHour"></tr>
                        <tr data-time="14:30" class="eachHour"></tr>
                        <tr data-time="15:00" class="eachHour"></tr>
                        <tr data-time="15:30" class="eachHour"></tr>
                        <tr data-time="16:00" class="eachHour"></tr>
                        <tr data-time="16:30" class="eachHour"></tr>
                        <tr data-time="17:00" class="eachHour"></tr>
                        <tr data-time="17:30" class="eachHour"></tr>
                        <tr data-time="18:00" class="eachHour"></tr>
                        <tr data-time="18:30" class="eachHour"></tr>
                        <tr data-time="19:00" class="eachHour"></tr>
                        <tr data-time="19:30" class="eachHour"></tr>
                        <tr data-time="20:00" class="eachHour"></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div style="position: fixed; bottom: 10px; right: 10px; width: 15%; height: fit-content; background-color: antiquewhite; display: flex; flex-direction: column; align-items: center;">
            <div>
                <input type="date" id="date">
                <input type="time" min="8:00" max="20:00" id="time" >
            </div>
        </div>
        <script>
            /*
            $.ajax({
                type: 'POST',
                url: '/book',
                data: {
                    idSalle:'63c9168807f074ce6dfb1b76',
                    idStage:'LBvmfTF4lOLPscw4pcjC',
                    start:new Date('2023-01-19 10:00'),
                    end:new Date('2023-01-19 15:00')
                },
                success: function (data) {
                    console.log(data.success)
                }
            });
            */
            
            let salles = [];
            let dateNow = new Date();
            let stage = '';

            

            window.onload = function(){
                if(parseInt(dateNow.getMinutes()) < 30){
                    dateNow.setMinutes(0, 0, 0);
                }
                else{
                    dateNow.setMinutes(30, 0, 0);
                }
                
                document.getElementById('date').value = dateNow.toISOString().substring(0,10);
                document.getElementById('time').value = dateNow.toLocaleString().substring(11,16);


                function setSize(){
                document.getElementById('myCanvas').width = 1536;
                document.getElementById('myCanvas').height = 676;
                }
                setSize();

                let params = new URLSearchParams(document.location.search);
                if(params.has("stage")){
                    stage = params.get("stage");
                }

                
                $.ajax({
                    type: 'POST',
                    url: '/loadPlan',
                    data: {
                        date:dateNow,
                        stage:stage
                    },
                    success: function (data) {
                        console.log(data)
                        console.log(JSON.parse(data.result1))
                        console.log(JSON.parse(data.result2))
                        console.log(JSON.parse(data.result3))
                        salles = JSON.parse(data.result2);
                        let books = JSON.parse(data.result3);
                        salles.forEach(element => {
                            const found = books.find(element2 => element2.idSalle == element._id);
                            if(found){
                                element.free = false;
                            }
                            else {
                                element.free = true;
                            }
                        });
                        drawAllPolygons();
                    }
                });

                

            }

            /* Changement du temps */

            document.getElementById('date').addEventListener('change', updateDateNow);
            document.getElementById('time').addEventListener('change', updateDateNow);

            function updateDateNow(){
                dateNow = new Date(document.getElementById('date').value + " " + document.getElementById('time').value);
                reloadPlan();
            }


            function reloadPlan(){
                $.ajax({
                    type: 'POST',
                    url: '/loadPlan',
                    data: {
                        date:dateNow,
                        stage:stage
                    },
                    success: function (data) {
                        console.log(data)
                        console.log(JSON.parse(data.result1))
                        console.log(JSON.parse(data.result2))
                        console.log(JSON.parse(data.result3))
                        salles = JSON.parse(data.result2);
                        let books = JSON.parse(data.result3);
                        salles.forEach(element => {
                            const found = books.find(element2 => element2.idSalle == element._id);
                            if(found){
                                element.free = false;
                            }
                            else {
                                element.free = true;
                            }
                        });
                        drawAllPolygons();
                    }
                });
            }








            /* Affichage du planning */

            var canvas = document.getElementById("myCanvas");
            
            var selected = 0;
            var hovering = false;
            var clicking = false;

            var ctx = canvas.getContext("2d");


            //Fonction pour dessiner tous les polygons de la liste
            function drawAllPolygons(){
                //ctx.clearRect(0 - canvas.offsetLeft, 0  - canvas.offsetTop, canvas.width - canvas.offsetLeft, canvas.height  - canvas.offsetTop);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.lineWidth = 5; // augmente l'épaisseur des lignes
                for (let i = 0; i < salles.length; i++) {
                    console.log(salles[i]);
                    console.log('test');
                    if(salles[i].free){
                        ctx.fillStyle = "#bfe3b4";
                    }else {
                        ctx.fillStyle = "#e35c38";
                    }
                    ctx.font = "20px Arial";
                    ctx.beginPath();
                    ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);
                    for (var j = 1; j < salles[i].tab.length; j++) {
                        ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fill();
                        ctx.restore();

                    //Ajoute le text
                    var nom = salles[i].nom;
                    ctx.fillStyle = "#000000";
                    var bounds = getBounds(salles[i].tab);
                    var xText = bounds.left + (bounds.right - bounds.left) / 2;
                    var yText = bounds.top + (bounds.bottom - bounds.top) / 2;
                    //ctx.fillText(nom, xText, yText);
                    ctx.fillText(nom, salles[i].tab[0][0] + 15 , salles[i].tab[0][1] + 30);
                        ctx.restore();

                    if(salles[i].proj) ctx.fillText('📽️', salles[i].tab[0][0] + 15 , salles[i].tab[0][1] + 50);
                    


                    // Dessiner les sommets du polygone
                    for (let j = 0; j < salles[i].tab.length; j++) {
                        ctx.fillStyle = "#000";
                        ctx.beginPath();
                        ctx.arc(salles[i].tab[j][0], salles[i].tab[j][1], 5, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                ctx.restore();
            }




            // Gestion de l'événement pour sélectionner un sommet ou une arête
            canvas.addEventListener('mousedown', function(event) {
                /*var x = event.clientX - canvas.offsetLeft;
                var y = event.clientY - canvas.offsetTop;*/
                let rect = canvas.getBoundingClientRect();
                let x = event.clientX - rect.left;
                let y = event.clientY - rect.top;
                console.log(x, y)
                clicking = false;
                selected = 0;
                for (let i = 0; i < salles.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);

                    for (var j = 0; j < salles[i].tab.length; j++) {
                    ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                    }
                    ctx.closePath();
                    // Vérifie si les coordonnées de la souris sont contenues dans le polygone
                    if (ctx.isPointInPath(x, y)) {
                        selected = i;
                        clicking = true;
                    }
                                        
                }
                if(clicking){
                    displaySalle(selected);
                }
                else{
                    hideSalle();
                }
            });

            // Gestion de l'événement pour déplacer le polygone ou redimensionner les sommets ou les arêtes
            /*canvas.addEventListener('mousemove', function(event) {
                let rect = canvas.getBoundingClientRect();
                let x = event.clientX - rect.left;
                let y = event.clientY - rect.top;
                hovering = false;
                selected = 0;
                for (let i = 0; i < salles.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);

                    for (var j = 0; j < salles[i].tab.length; j++) {
                    ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                    }
                    ctx.closePath();
                    // Vérifie si les coordonnées de la souris sont contenues dans le polygone
                    if (ctx.isPointInPath(x, y)) {
                        selected = i;
                        hovering = true;
                    }
                                        
                }
                if(hovering){
                    displaySalle(selected);
                }
                else{
                    hideSalle();
                }
            });*/


            
            function getBounds(polygon) {
                var left = polygon[0][0];
                var right = polygon[0][0];
                var top = polygon[0][1];
                var bottom = polygon[0][1];
                for (var i = 1; i < polygon.length; i++) {
                    if (polygon[i][0] < left) {
                        left = polygon[i][0];
                    }
                    if (polygon[i][0] > right) {
                        right = polygon[i][0];
                    }
                    if (polygon[i][1] < top) {
                        top = polygon[i][1];
                    }
                    if (polygon[i][1] > bottom) {
                        bottom = polygon[i][1];
                    }
                }
                return {left: left, right: right, top: top, bottom: bottom};
            }





            function displaySalle(i){
                salle = salles[i];
                document.getElementById('bulleInfo').style.visibility = "visible";
                document.getElementById('name').innerText = salle.nom;
                let textProj = 'Non';
                if(salle.proj) textProj = 'Oui'
                document.getElementById('proj').innerText = textProj;

                document.getElementById('day').innerText = dateNow.toLocaleString()


                $.ajax({
                    type: 'POST',
                    url: '/loadSchedule',
                    data: {
                        date:dateNow,
                        salle:salles[i]._id
                    },
                    success: function (data) {
                        console.log(data)
                        console.log(JSON.parse(data.result))
                        let books = JSON.parse(data.result);
                        let listCases = Array.from(document.getElementsByClassName('eachHour'));
                        console.log(listCases);
                        
                        listCases.forEach(element => {
                            console.log(1674118800000 <= Date(document.getElementById('date').value + ' ' + '10:00'));
                            const found = books.find(element2 => (element2.start <= Date(document.getElementById('date').value + ' ' + element.dataset.time) && element2.end >= Date(document.getElementById('date').value + ' ' + element.dataset.time)));
                            if(found){
                                element.style.backgroundColor = 'red';
                            }
                            else {
                                element.style.backgroundColor = 'green';
                            }
                        });

                    }
                });
            }

            function hideSalle(){
                document.getElementById('bulleInfo').style.visibility = "hidden";
            }
        </script>
    </body>

</html>