<!DOCTYPE html>
<html lang=fr>

<head>
    <meta charset="utf-8">
    <title>Polygone</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="../js/Salle.js"></script>
</head>

<body style="margin: 0;">
    <canvas oncontextmenu="return false;" id="myCanvas" style="margin: auto;"></canvas><!--width="900" height="500"-->
    <div
        style="position: fixed; top: 10px; right: 10px; width: 15%; height: fit-content; background-color: antiquewhite; display: flex; flex-direction: column; align-items: center;">
        <label for="name">Nom de la salle</label>
        <input id="name" type="text" value="B804">
        <div>
            <label for="proj">Vid√©o projecteur</label>
            <input id="proj" type="checkbox">
        </div>
        <div>
            <label for="nb">Nombre de places</label>
            <input id="nb" type="number" min="0" max="500">
        </div>
        <button id="newPolygon">Nouvelle salle</button>
        <div id="container"></div>
    </div>
    <div
        style="position: fixed; bottom: 10px; right: 10px; width: 15%; height: fit-content; background-color: rgb(205, 255, 222); display: flex; flex-direction: column; align-items: center;">
        <label for="name">Nom du plan</label>
        <input id="name_stage" type="text" placeholder="Etage X">
        <button id="send">Enregistrer</button>
        <div id="container"></div>
    </div>
    <script>
        function setSize() {
            document.getElementById('myCanvas').width = window.innerWidth;
            document.getElementById('myCanvas').height = window.innerHeight;
        }
        setSize();




        var canvas = document.getElementById("myCanvas");
        var salles = [];

        window.onload = function () {
            var ctx = canvas.getContext("2d");
            var polygons = []; // Liste pour stocker les sommets de chaque polygone
            var selected = false;
            var selectedVertex = -1;
            var selectedEdge = -1;
            var startX, startY, endX, endY;
            var scaleFactor = 1.1;


            //Fonction pour dessiner tous les polygons de la liste
            function drawAllPolygons() {
                //ctx.clearRect(0 - canvas.offsetLeft, 0  - canvas.offsetTop, canvas.width - canvas.offsetLeft, canvas.height  - canvas.offsetTop);
                ctx.clearRect(0, 0, canvas.width, canvas.height);



                ctx.lineWidth = 7; // augmente l'√©paisseur des lignes
                for (let i = 0; i < salles.length; i++) {
                    ctx.fillStyle = "#26c4ec";
                    ctx.font = "20px Arial";
                    ctx.beginPath();
                    ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);
                    for (var j = 1; j < salles[i].tab.length; j++) {
                        ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fill();
                    ctx.restore();

                    //Ajoute le text
                    var nom = salles[i].nom;
                    ctx.fillStyle = "#000000";
                    var bounds = getBounds(salles[i].tab);
                    var xText = bounds.left + (bounds.right - bounds.left) / 2;
                    var yText = bounds.top + (bounds.bottom - bounds.top) / 2;
                    //ctx.fillText(nom, xText, yText);
                    ctx.fillText(nom, salles[i].tab[0][0] + 15, salles[i].tab[0][1] + 30);
                    ctx.restore();

                    if (salles[i].proj) ctx.fillText('üìΩÔ∏è', salles[i].tab[0][0] + 15, salles[i].tab[0][1] + 50);
                    /*if(salles[i].proj){
                      base_image = new Image();
                      base_image.src = 'proj.png';
                      base_image.onload = function(){
                        ctx.drawImage(base_image, xText, yText + 10);
                      }
                    }*/


                    // Dessiner les sommets du polygone
                    for (let j = 0; j < salles[i].tab.length; j++) {
                        ctx.fillStyle = "#000";
                        ctx.beginPath();
                        ctx.arc(salles[i].tab[j][0], salles[i].tab[j][1], 7, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                ctx.restore();
            }


            // Gestion de l'√©v√©nement pour dessiner un nouveau polygone
            document.getElementById("newPolygon").addEventListener("click", function () {

                let name = document.getElementById('name').value;

                let proj = document.getElementById('proj');

                let places = document.getElementById('nb').value;

                addSalle(name, proj, places)
            });
            drawAllPolygons();


            function addSalle(name, proj, places) {
                if (name !== '' && proj) {

                    var newSalle = new Salle(structuredClone(name), proj.checked, structuredClone(places), [[50, 50], [200, 50], [200, 200], [50, 200]]);

                    salles.push(newSalle);

                    //displaySalle(newSalle);

                    //polygons.push([[50, 50], [200, 50], [200, 200], [50, 200]]);
                    drawAllPolygons();

                    // R√©initialise les transformations
                    ctx.setTransform(1, 0, 0, 1, 0, 0);


                    //document.getElementById('name').value = '';
                }
            }

            // Gestion de l'√©v√©nement pour s√©lectionner un sommet ou une ar√™te
            canvas.addEventListener('mousedown', function (event) {
                var x = event.clientX - canvas.offsetLeft;
                var y = event.clientY - canvas.offsetTop;
                if (selected === false) {
                    for (let i = 0; i < salles.length; i++) {

                        if (event.buttons == 2) {
                            ctx.beginPath();
                            ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);

                            for (var j = 0; j < salles[i].tab.length; j++) {
                                ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                            }
                            ctx.closePath();
                            // V√©rifie si les coordonn√©es de la souris sont contenues dans le polygone
                            if (ctx.isPointInPath(x, y)) {
                                salles.splice(i, 1);
                                console.log('suppression');
                                drawAllPolygons();
                            }
                        }
                        else {
                            ctx.beginPath();
                            ctx.moveTo(salles[i].tab[0][0], salles[i].tab[0][1]);


                            for (var j = 0; j < salles[i].tab.length; j++) {
                                ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                            }
                            ctx.closePath();
                            // V√©rifie si les coordonn√©es de la souris sont contenues dans le polygone
                            if (ctx.isPointInPath(x, y)) {
                                selected = bringFront(i); // Stock l'indice du polygone s√©lectionn√© et le met devant les autres
                                startX = x;
                                startY = y;
                                document.body.style.cursor = "grab";

                            }


                            ctx.beginPath();
                            for (var j = 0; j < salles[i].tab.length; j++) {
                                ctx.lineTo(salles[i].tab[j][0], salles[i].tab[j][1]);
                                // V√©rifie si les coordonn√©es de la souris sont contenues dans une ar√™te du polygone
                                if (ctx.isPointInStroke(x, y)) {
                                    selected = bringFront(i);
                                    selectedEdge = j;
                                    startX = x;
                                    startY = y;
                                    document.body.style.cursor = "move";
                                    break;
                                }
                                //Du dernier point au premier
                                ctx.lineTo(salles[i].tab[0][0], salles[i].tab[0][1]);
                                if (ctx.isPointInStroke(x, y)) {
                                    selected = bringFront(i);
                                    selectedEdge = 0;
                                    startX = x;
                                    startY = y;
                                    document.body.style.cursor = "move";
                                    break;
                                }
                                // V√©rifie si les coordonn√©es de la souris sont contenues dans un sommet du polygone
                                ctx.beginPath();
                                ctx.arc(salles[i].tab[j][0], salles[i].tab[j][1], 7, 0, 2 * Math.PI);
                                if (ctx.isPointInPath(x, y)) {
                                    selected = bringFront(i);
                                    selectedVertex = j;
                                    startX = x;
                                    startY = y;
                                    document.body.style.cursor = "move";
                                    break;
                                }
                            }


                            drawAllPolygons(); // On actualise 
                        }
                    }
                }
            });

            // Gestion de l'√©v√©nement pour d√©placer le polygone ou redimensionner les sommets ou les ar√™tes
            canvas.addEventListener('mousemove', function (event) {
                if (selected !== false) {
                    endX = event.clientX - canvas.offsetLeft;
                    endY = event.clientY - canvas.offsetTop;
                    var dx = endX - startX;
                    var dy = endY - startY;

                    // V√©rifie si le polygone s√©lectionn√© se chevauche avec un autre polygone
                    /*var collision = false;
                    for (let i = 0; i < salles.length; i++) {
                        if (i !== selected && checkPolygonCollision(salles[selected].tab, salles[i].tab)) {
                            collision = true;
                            break;
                        }
                    }*/

                    // Applique la transformation de d√©placement ou de redimensionnement si aucune collision n'est d√©tect√©e
                    //if (!collision) {
                    // Applique la transformation de d√©placement ou de redimensionnement en fonction de la s√©lection
                    if (selectedVertex !== -1) {
                        salles[selected].tab[selectedVertex][0] += dx;
                        salles[selected].tab[selectedVertex][1] += dy;
                    } else if (selectedEdge !== -1) {
                        if (startX < salles[selected].tab[mod((selectedEdge - 1), 4)][0] + 4 && startX > salles[selected].tab[mod((selectedEdge - 1), 4)][0] - 4) salles[selected].tab[mod((selectedEdge - 1), 4)][0] += dx;
                        if (startY < salles[selected].tab[mod((selectedEdge - 1), 4)][1] + 4 && startY > salles[selected].tab[mod((selectedEdge - 1), 4)][1] - 4) salles[selected].tab[mod((selectedEdge - 1), 4)][1] += dy;
                        if (startX < salles[selected].tab[mod((selectedEdge), 4)][0] + 4 && startX > salles[selected].tab[mod((selectedEdge), 4)][0] - 4) salles[selected].tab[mod((selectedEdge), 4)][0] += dx;
                        if (startY < salles[selected].tab[mod((selectedEdge), 4)][1] + 4 && startY > salles[selected].tab[mod((selectedEdge), 4)][1] - 4) salles[selected].tab[mod((selectedEdge), 4)][1] += dy;
                    } else {
                        for (let i = 0; i < salles[selected].tab.length; i++) {
                            salles[selected].tab[i][0] += dx;
                            salles[selected].tab[i][1] += dy;
                        }
                    }
                    startX = endX;
                    startY = endY;
                    drawAllPolygons();
                    //}
                }
            });


            // Gestion de l'√©v√©nement pour d√©s√©lectionner le polygone, le sommet ou l'ar√™te
            canvas.addEventListener('mouseup', function (event) {
                selected = false;
                selectedVertex = -1;
                selectedEdge = -1;
                document.body.style.cursor = "auto";
            });




            function bringFront(i) {
                let elem = salles.splice(i, 1);
                salles.push(elem[0]);
                return salles.length - 1;
            }






            function checkPolygonCollision(polygon1, polygon2) {
                var poly1Bounds = getBounds(polygon1);
                var poly2Bounds = getBounds(polygon2);
                return poly1Bounds.left <= poly2Bounds.right && poly1Bounds.right >= poly2Bounds.left &&
                    poly1Bounds.top <= poly2Bounds.bottom && poly1Bounds.bottom >= poly2Bounds.top;
            }

            function getBounds(polygon) {
                var left = polygon[0][0];
                var right = polygon[0][0];
                var top = polygon[0][1];
                var bottom = polygon[0][1];
                for (var i = 1; i < polygon.length; i++) {
                    if (polygon[i][0] < left) {
                        left = polygon[i][0];
                    }
                    if (polygon[i][0] > right) {
                        right = polygon[i][0];
                    }
                    if (polygon[i][1] < top) {
                        top = polygon[i][1];
                    }
                    if (polygon[i][1] > bottom) {
                        bottom = polygon[i][1];
                    }
                }
                return { left: left, right: right, top: top, bottom: bottom };
            }

            /*document.getElementById('zoom').addEventListener('click', function (){
              ctx.scale(scaleFactor, scaleFactor)
              drawAllPolygons();
            });
            document.getElementById('unzoom').addEventListener('click', function (){
              ctx.scale(0.9, 0.9)
              drawAllPolygons();
            });*/







        }

        function displaySalle(salle) {
            let container = document.getElementById('container');
            let containerSalle = document.createElement('div');
            let p = document.createElement('p');
            p.innerText = salle.nom;
            containerSalle.appendChild(p);
            if (proj) {
                let p2 = document.createElement('p');
                p2.innerText = 'Vid√©o projecteur';
                containerSalle.appendChild(p2);
            }
            container.appendChild(containerSalle);
        }

        document.getElementById('send').addEventListener('click', function () {
            if (salles.length != 0) {
                let nameStage = document.getElementById('name_stage').value;
                let nbPlaces = document.getElementById('nb').value;
                if (nameStage != "") {
                    console.log("Etage : " + nameStage);
                    console.log("Places disponibles : " + nbPlaces);
                    console.log(JSON.stringify(salles));
                    console.log(JSON.parse(JSON.stringify(salles)));
                    $.ajax({
                        type: 'POST',
                        url: '/save',
                        data: {
                            name: nameStage,
                            nbPlaces: nbPlaces,
                            salles: JSON.stringify(salles)
                        },
                        success: function () {

                        }
                    });
                } else { alert('Veuillez nommer votre plan') }
            } else { alert('Aucune salle enregistr√©e') }
        });




        function mod(n, m) {
            return ((n % m) + m) % m;
        }
    </script>
</body>

</html